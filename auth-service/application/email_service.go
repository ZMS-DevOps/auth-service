package application

import (
	"bytes"
	"github.com/afiskon/promtail-client/promtail"
	"github.com/go-mail/mail"
	"github.com/mmmajder/zms-devops-auth-service/domain"
	"github.com/mmmajder/zms-devops-auth-service/util"
	"go.opentelemetry.io/otel/trace"
	"html/template"
	"log"
)

type EmailService struct{}

func NewEmailService() *EmailService {
	return &EmailService{}
}

func (service *EmailService) GetVerificationCodeEmailBody(receiverEmail string, verification domain.Verification, span trace.Span, loki promtail.Client) string {
	util.HttpTraceInfo("Getting verification code email body...", span, loki, "GetVerificationCodeEmailBody", "")
	t, _ := template.New("verification_email").Parse(service.getHtmlTemplate())
	var body bytes.Buffer
	if err := service.executeEmail(receiverEmail, verification, t, &body); err != nil {
		return ""
	}

	return body.String()
}

func (service *EmailService) SendEmail(subject, body string, span trace.Span, loki promtail.Client) {
	util.HttpTraceInfo("Sending email...", span, loki, "SendEmail", "")
	m := mail.NewMessage()
	m.SetHeader("From", domain.SenderEmailAddress)
	m.SetHeader("To", domain.SenderEmailAddress)
	m.SetHeader("Subject", subject)
	m.SetBody("text/html", body)

	d := mail.NewDialer(domain.EmailHost, domain.EmailPort, domain.SenderEmailAddress, domain.AppPassword)

	if err := d.DialAndSend(m); err != nil {
		log.Fatal(err)
	}
}

func (service *EmailService) getVerificationCodeUrl(receiverEmail string, verification domain.Verification) string {
	return "http://localhost/app/booking/auth/verify/" + verification.Id.Hex() + "?email=" + receiverEmail + "&userId=" + verification.UserId
}

func (service *EmailService) executeEmail(receiverEmail string, verification domain.Verification, t *template.Template, body *bytes.Buffer) error {
	return t.Execute(body, struct {
		Code int
		Url  string
	}{
		Code: verification.Code,
		Url:  service.getVerificationCodeUrl(receiverEmail, verification),
	})
}

func (service *EmailService) getHtmlTemplate() string {
	return "<!doctype html>\n<html data-css-strict>\n\n<head>\n    <meta charset=\"utf-8\">\n    <meta name=\"x-apple-disable-message-reformatting\">\n    <style amp4email-boilerplate>\n        body {\n            visibility: hidden\n        }\n    </style>\n\n    <style amp-custom>\n        .u-row {\n            display: flex;\n            flex-wrap: nowrap;\n            margin-left: 0;\n            margin-right: 0;\n        }\n\n        .u-row .u-col {\n            position: relative;\n            width: 100%;\n            padding-right: 0;\n            padding-left: 0;\n        }\n\n        .u-row .u-col.u-col-100 {\n            flex: 0 0 100%;\n            max-width: 100%;\n        }\n\n        @media (max-width: 767px) {\n            .u-row:not(.no-stack) {\n                flex-wrap: wrap;\n            }\n            .u-row:not(.no-stack) .u-col {\n                flex: 0 0 100%;\n                max-width: 100%;\n            }\n        }\n\n        body {\n            margin: 0;\n            padding: 0;\n        }\n\n        table,\n        tr,\n        td {\n            vertical-align: top;\n            border-collapse: collapse;\n        }\n\n        p {\n            margin: 0;\n        }\n\n        .ie-container table,\n        .mso-container table {\n            table-layout: fixed;\n        }\n\n        * {\n            line-height: inherit;\n        }\n\n        table,\n        td {\n            color: #000000;\n        }\n\n        a {\n            color: #0000ee;\n            text-decoration: underline;\n        }\n    </style>\n\n\n</head>\n\n<body class=\"clean-body u_body\" style=\"margin: 0;padding: 0;background-color: #f9f9f9;color: #000000\">\n<!--[if IE]><div class=\"ie-container\"><![endif]-->\n<!--[if mso]><div class=\"mso-container\"><![endif]-->\n<table style=\"border-collapse: collapse;table-layout: fixed;border-spacing: 0;vertical-align: top;min-width: 320px;Margin: 0 auto;background-color: #f9f9f9;width:100%\" cellpadding=\"0\" cellspacing=\"0\">\n    <tbody>\n    <tr style=\"vertical-align: top\">\n        <td style=\"word-break: break-word;border-collapse: collapse;vertical-align: top\">\n            <!--[if (mso)|(IE)]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td align=\"center\" style=\"background-color: #f9f9f9;\"><![endif]-->\n\n            <div style=\"padding: 0px;\">\n                <div style=\"max-width: 600px;margin: 0 auto;\">\n                    <div class=\"u-row\">\n\n                        <div class=\"u-col u-col-100\">\n                            <div style=\"padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:10px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"color: #afb0c7; line-height: 170%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"font-size: 14px; line-height: 170%;\"><span style=\"font-size: 14px; line-height: 23.8px;\">View Email in Browser</span></p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                            </div>\n                        </div>\n\n                    </div>\n                </div>\n            </div>\n\n            <div style=\"padding: 0px;\">\n                <div style=\"max-width: 600px;margin: 0 auto;background-color: #71af91;\">\n                    <div class=\"u-row\">\n\n                        <div class=\"u-col u-col-100\">\n                            <div style=\"padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:40px 10px 10px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n                                                <tr>\n                                                    <td style=\"padding-right: 0px;padding-left: 0px;\" align=\"center\">\n\n\n                                                    </td>\n                                                </tr>\n                                            </table>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:10px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"color: #e5eaf5; line-height: 140%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"font-size: 14px; line-height: 140%;\"><strong>T H A N K S&nbsp; &nbsp;F O R&nbsp; &nbsp;S I G N I N G&nbsp; &nbsp;U P !</strong></p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:0px 10px 31px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"color: #e5eaf5; line-height: 140%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"font-size: 14px; line-height: 140%;\"><span style=\"font-size: 28px; line-height: 39.2px;\"><strong><span style=\"line-height: 39.2px; font-size: 28px;\">Verify Your E-mail Address </span></strong>\n                                    </span>\n                                                </p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                            </div>\n                        </div>\n\n                    </div>\n                </div>\n            </div>\n            <div style=\"padding: 0px;\">\n                <div style=\"max-width: 600px;margin: 0 auto;background-color: #ffffff;\">\n                    <div class=\"u-row\">\n\n                        <div class=\"u-col u-col-100\">\n                            <div style=\"padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:33px 55px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"line-height: 160%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 22px; line-height: 35.2px;\">Hi, </span></p>\n                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 18px; line-height: 28.8px;\">You're almost ready to get started. Please click on the button below to verify your email address and enjoy exclusive booking services with us! </span></p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:33px 55px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"line-height: 160%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 22px; line-height: 35.2px;\">Your verification code</span></p>\n                                                <p style=\"font-size: 14px; line-height: 160%;\"><span style=\"font-size: 30px; line-height: 45px;\">{{.Code}}</span></p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:10px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div align=\"center\">\n                                                <!--[if mso]><table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"border-spacing: 0; border-collapse: collapse;  font-family:'Cabin',sans-serif;\"><tr><td style=\"font-family:'Cabin',sans-serif;\" align=\"center\"><v:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" style=\"height:46px; v-text-anchor:middle; width:234px;\" arcsize=\"8.5%\" stroke=\"f\" fillcolor=\"\"#ff6600\"><w:anchorlock/><center style=\"color:#FFFFFF;font-family:'Cabin',sans-serif;\"><![endif]-->\n                                                <a target=\"_blank\" href={{.Url}} style=\"box-sizing: border-box;display: inline-block;font-family:'Cabin',sans-serif;text-decoration: none;text-align: center;color: #FFFFFF; background-color: #71af91; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2); border-radius: 4px;  width:auto; max-width:100%; overflow-wrap: break-word; word-break: break-word; word-wrap:break-word; \">\n                                        <span style=\"display:block;padding:14px 44px 13px;line-height:120%;\"><span style=\"font-size: 16px; line-height: 19.2px;\"><strong><span style=\"line-height: 19.2px; font-size: 16px;\">VERIFY YOUR EMAIL</span></strong>\n                                        </span>\n                                        </span>\n                                                </a>\n                                                <!--[if mso]></center></v:roundrect></td></tr></table><![endif]-->\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:33px 55px 60px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"line-height: 160%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"line-height: 160%; font-size: 14px;\"><span style=\"font-size: 18px; line-height: 28.8px;\">Thanks,</span></p>\n                                                <p style=\"line-height: 160%; font-size: 14px;\"><span style=\"font-size: 18px; line-height: 28.8px;\">The Booking Team</span></p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                            </div>\n                        </div>\n\n                    </div>\n                </div>\n            </div>\n\n            <div style=\"padding: 0px;\">\n                <div style=\"max-width: 600px;margin: 0 auto;background-color: #e5eaf5;\">\n                    <div class=\"u-row\">\n\n                        <div class=\"u-col u-col-100\">\n                            <div style=\"padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\n\n\n                            </div>\n                        </div>\n\n                    </div>\n                </div>\n            </div>\n\n            <div style=\"padding: 0px;\">\n                <div style=\"max-width: 600px;margin: 0 auto;background-color: #71af91;\">\n                    <div class=\"u-row\">\n\n                        <div class=\"u-col u-col-100\">\n                            <div style=\"padding: 0px;border-top: 0px solid transparent;border-left: 0px solid transparent;border-right: 0px solid transparent;border-bottom: 0px solid transparent;\">\n\n                                <table style=\"font-family:'Cabin',sans-serif;\" role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\">\n                                    <tbody>\n                                    <tr>\n                                        <td style=\"overflow-wrap:break-word;word-break:break-word;padding:10px;font-family:'Cabin',sans-serif;\" align=\"left\">\n\n                                            <div style=\"color: #fafafa; line-height: 180%; text-align: center; word-wrap: break-word;\">\n                                                <p style=\"font-size: 14px; line-height: 180%;\"><span style=\"font-size: 16px; line-height: 28.8px;\">Copyrights &copy; Booking All Rights Reserved</span></p>\n                                            </div>\n\n                                        </td>\n                                    </tr>\n                                    </tbody>\n                                </table>\n\n                            </div>\n                        </div>\n\n                    </div>\n                </div>\n            </div>\n\n            <!--[if (mso)|(IE)]></td></tr></table><![endif]-->\n        </td>\n    </tr>\n    </tbody>\n</table>\n<!--[if mso]></div><![endif]-->\n<!--[if IE]></div><![endif]-->\n</body>\n\n</html>"
}
